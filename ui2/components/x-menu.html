<link rel="import"  href="https://polygit.org/polymer+2.0.0-rc.2/components/polymer/polymer-element.html">
<link rel="import" href="https://polygit.org/polymer+2.0.0-rc.2/components/polymer/lib/elements/dom-repeat.html">


<dom-module id='x-menu'>
    <script src="./../libs/drag.js"></script>
	<template>
		<style>
		:host {
			/*box-shadow: 3px 3px 5px 1px #ccc;*/
			border: 1px solid #a1a1a1;
			color: #000000;
			display: inline-block;
			min-width:15em;
			max-width:90%;
			position:relative;
			background-color:white;
			border-radius: 0.8em;
			overflow:hidden;
			z-index: 100;
			margin-left:50%
			margin-rigth:50%;
			visibility: hidden;
			position:fixed;
			border-collapse:separate;
		}
		.selected {
			background-image: none;
			border-color:orange;
			outline: none;
			box-shadow: 0 0 10px orange;
			background-color: orange;
		}
		.selected td{
			background-color: orange;
		}
		.hidden {
			width: 0px;
			height: 0px;
			visibility:hidden;
			display:none;
			overflow:hidden;
		}
		.title {
			background: linear-gradient(to bottom, #cdd2d8 8%,#989a9b 100%); /* W3C */
			text-shadow:#CECECE 0px 1px 0, #000 0 -1px 0;
			font-weight:bold;
			font-size:0.8em;
			color: #757575;
			text-align: center;
/*			position:fixed;*/
		}
		.title span {
			position:absolute;
			top:0px;
			right:1em; 
		}
		.title input {
			padding:0.4em;
			border-radius: 0.4em;
			color: grey;
			font-size:1.2em;
			width:90%;
			margin:0.8em;
			margin-top:0px;
		}
		table, thead, tbody, tfooter {
			width: 100%;
			border: 0px;
			padding:0px;
			margin:0px;
			/*border-collapse: collapse;*/
			border-spacing: 0;
		}
		thead {
			font-weight:bold;
			color:white;
			font-size: 0.8em;
		}
		thead td{
			background: linear-gradient(15deg, #616161 0%,#616161 4%,#7c7c7c 100%); /* W3C */
			padding: 0.2em;
		}
		tbody tr {
			background-image: linear-gradient(to bottom, #ffffff 0%,#ffffff 88%,#eaeaea 100%);
		}
		tbody td {
			border-left: 1px solid #e1e1e1;
			padding: 0.2em;
		}
		.hiddenColumn #foo.hide2 tr *:nth-child(2) {
    display: none;
}

		</style>
		<div class="title">
			<div id="dragger" class="dragger">{{title}} <span>pag.{{page}}/{{pages}}</span></div>
			<input 
				id="searchfield"
				placeholder="Digita qui per cercare..."
				type="text"
				tabindex="0"
				value="{{searchstring:change}}"
				on-focus="onInputFocus"
				on-blur="onInputBlur"
				on-keydown="onInputKeydown"
			>
		</div>
		<div id="items">
			<table id="table">
				<thead id="tableHead"></thead>
				<tbody id="tableBody">
					<template is="dom-repeat" items="{{items}}">
					<tr>
					<td>
						{{item.label}}
					</td>
					</tr>
					</template> 
				</tbody>
				<tfoot id="tableFooter"></tfoot>
			</table>
		</div>
		
	</template>
	<script>
		// Define the class for a new element called custom-element
		class xMenu extends Polymer.Element {
			static get is() { return "x-menu"; }
			constructor() {
				super();
			}
			static get properties() {
				return {
					title: {
						type: String,
						reflectToAttribute: true,
						value:'Default Title',
					},
					page: {
						type: Number,
						reflectToAttribute: true,
					},
					pages: {
						type: Number,
						reflectToAttribute: true,
					},
					searchstring: {
						type: String,
						reflectToAttribute: true,
					},
					items: {
						type: Array,
						reflectToAttribute: true,
					},
					selectedId:{
						type: Number,
						reflectToAttribute: true,
						value:0,
					},
				}
			}
/*
events methods
*/
			onInputFocus(event, detail, sender){
				console.log("x-menu: got focus");
			}
			onInputBlur(event, detail, sender){
				console.log("x-menu: lost focus");
			}
			onInputKeydown(event, detail, sender){
				console.log("x-menu: keydown");
				switch (event.which){
					case 38: console.log("up");this.selectPrev();console.log("up:done");break; //up
					case 40: this.selectNext();break; //down
					case 33: this.selectFirstOfThePage();break; //pgup
					case 34: this.selectLastOfThePage();break; //pgdown
					case 13: this.confirm(); break; //enter
					case 27: this.cancel(); break; //esc
				}
			}
/*
custom methods
*/
		ready(){
			super.ready();
			
			//make our element focusable
			this.tabIndex = 0
			
			//and draggable
			Drag.init(
				this.$.dragger,
				this
			);
			
			this.keepAliveOnConfirm=false;
			
			if(this.params!=null){
				//console.log('XMENU: Send a request to the server with params: ',this.params);
				this.getFromServer();
			}else{
				console.log('XMENU: No params set at creation time, wait for some');
			}
			this.focus();
			
			//manage keyboard events
			this.addEventListener("onkeydown", function(event) {
				switch (event.which){
					case 38: this.selectPrev();break; //up
					case 40: this.selectNext();break; //down
					case 33: this.selectFirstOfThePage();break; //pgup
					case 34: this.selectLastOfThePage();break; //pgdown
					case 13: this.confirm(); break; //enter
					case 27: this.cancel(); break; //esc
				}
			},false);
			
			//manage keyboard events
			this.addEventListener("focus", function(event) {
				console.log("give focus to the input");
				this.$.searchfield.focus()
			}.bind(this),false);
			
			//manage propchange events
			this.addEventListener("items-changed", function(event) {
				console.log("items changed!!!!");
				//select the first element
				if(this.items.length > 0){
					this.selectedId=0;
					this.selectItemById(this.selectedId);
				}

			}.bind(this),false);

		}
		selectItemById(id){
			//remove selected class from current element
			this.$.table.rows[this.selectedId].classList.remove("selected");
			//select the new element
			this.selectedId = id;
			//apply the selected class to the new element
			this.$.table.rows[id].classList.add("selected");
		}
		selectNext(){
			console.log("select next");
			this.selectItemById(this.selectedId+1);
		}
		selectPrev(id){
			this.selectItemById(this.selectedId-1);
		}
		getSelected(){
			return this.items[this.selectedId];
		}
		confirm(){
			//an utility function
			function isFunction(functionToCheck) {
				var getType = {};
				return functionToCheck && getType.toString.call(functionToCheck) === '[object Function]';
			}
			
			//fire the action assigned to the element if there is one
			if (isFunction(this.getSelected()._action)){
				this.getSelected()._action();
			}
			
			//call the onConfirma callback
			this.onConfirm(this.getSelected());

			//if is present remove the modalbackground
			if(this.modalBackground){
				//console.log('XMENU: remove the modal  background')
				this.parentNode.removeChild(this.modalBackground);
			}
			//remove me from the dom
			//console.log('XMENU: remove the menu from the dom')
			if(!this.keepAliveOnConfirm){
				this.parentNode.removeChild(this);
			}
			//and quit
			
			return;
		}
		cancel(){
			this.onCancel();
			//if is present remove the modalbackground
			if(this.modalBackground){
				this.parentNode.removeChild(this.modalBackground);
			}
			//remove me from the dom without returning any value
			this.parentNode.removeChild(this);
		}
		onConfirm(selectedObj){
			//use this as a callback
			//return an obj of the selected menu-entry
			return;
		}
		onCancel(){
			//use this as a callback
		}

		getFromServer(){
			//perform an ajax request to get the list to display
			$.ajax({
				type: "POST",
				url: "./../do.php",
				data: {
						action: 'getAll',
						params: $.parseJSON(this.params)
						},
				context: this,
			}).done(function( msg ) {
					console.log(msg);
					//console.log('Jsonize the reponse:');
					var jsonList = $.parseJSON(msg);
					//the full array of objects we will use
					this.fulllist = jsonList;
					//generate a copy of the array to use
					//this.list = this.fulllist.slice(0);
					//console.log(jsonList);
					//console.log('Create the table');
					var table = this.generateTable (this.fulllist, $.parseJSON(this.params));
					//console.log('Append the table to the shadow dom');
					//this.$.items.appendChild(table);
					//console.log('Our new dom for Items is now:');
					//console.log(this.$.items.innerHTML);
					//console.log('Generate the menu');
					//console.log(table.tBodies)
					this.createMenu (table.tBodies[0].children);
					this.searchstringChanged();
					this.onReady();
			});
		}

		setPosition(myPoint, targetPoint, targetElement, modifier){
			//console.log('XMENU: my current position: ', this.getPosition(this))
			//console.log(this.impl)

			var targetPosition = this.getPosition(targetElement);
			var targetDimensions = {
				width : targetElement.offsetWidth,
				height:  targetElement.offsetHeight,
			};
			var myDimensions = {
				width : this.offsetWidth,
				height:  this.offsetHeight,
			};
			
			var np ={
				top:0,
				left:0,
			}
			
			switch(myPoint[0]){
				case 't':np.top+=0;break;
				case 'b':np.top-=myDimensions.height;break;
				case 'c':np.top-=myDimensions.height/2;break;
			}

			switch(targetPoint[0]){
				case 't':np.top+=0;break;
				case 'b':np.top+=targetDimensions.height;break;
				case 'c':np.top+=targetDimensions.height/2;break;
			}
			
			switch(myPoint[1]){
				case 'l':np.left+=0;break;
				case 'r':np.left-=myDimensions.width;break;
				case 'c':np.left-=myDimensions.width/2;break;
			}

			switch(targetPoint[1]){
				case 'l':np.left+=0;break;
				case 'r':np.left+=targetDimensions.width;break;
				case 'c':np.left+=targetDimensions.width/2;break;
			}
			
			//apply the modifier if exist
			if(modifier){
				targetPosition.left+= modifier.left;
				targetPosition.top+= modifier.top;
			}
			
			//
			np.left+=targetPosition.left;
			np.top+=targetPosition.top;
			
			//console.log('XMENU: new position:', np);
			
			//assign the new position
			this.style.top = np.top+'px';
			this.style.left = np.left+'px';
			
			//console.log('XMENU: targetPOS', targetPosition, 'targetDIM: ', targetDimensions, 'myDIM: ', myDimensions);
			
		}
		getPosition(element) {
			var xPosition = 0;
			var yPosition = 0;
			while(element) {
				xPosition += (element.offsetLeft - element.scrollLeft + element.clientLeft);
				yPosition += (element.offsetTop - element.scrollTop + element.clientTop);
				element = element.offsetParent;
			}
			return { left: xPosition, top: yPosition };
		}
		show(){
			this.style.visibility='visible';
		}
		hide(){
			this.style.visibility='hidden';
		}
		paramsChanged(){
			//creo i parametri della query da una stringa json
			if(this.params){
				this.params = this.params.replace("'/g", '"');
				//ricavo i dati con cui riempire la finestra
				this.getFromServer();
			}
			/*
			if(this.jsonList){
				this.jsonList = $.parseJSON(this.jsonList)
				this.jsonToTable(this.jsonList);
			}
			*/
		}
		searchstringChanged(){
			//console.log('XMENU: searching for >'+this.searchstring+'< into: ', this.list);
			var searchstring = this.searchstring.toLowerCase();
			
			var filteredItems = this.fulllist.filter(function(item){
				var result = false;
				for (prop in item){
					var fullstring = item[prop].toLowerCase();
					result = fullstring.search(searchstring);
					//console.log('XMENU: scanned: ', fullstring, ' for: ', searchstring, 'with result: ', result)
					if (result > -1) return true;
					}
				});
				
			
			this.list = filteredItems;
			//console.log('XMENU: found:', filteredItems)
			//reset the prev selection;
			this.selected = null;
			//regenerate the menu
			var table = this.generateTable (this.list, $.parseJSON(this.params));
			//console.log('delette the prev table')
			this.$.items.innerHTML = '';
			//console.log('Append the new table to the shadow dom');
			this.$.items.appendChild(table);
			//console.log('Generate the menu');
			//console.log(table.tBodies)
			this.createMenu (table.tBodies[0].children);
			
		}
		/*
		onfocus(){
			//send the focus to the input field
			//this.$.searchfield.focus();
		}
		*/
		
		addModalBackground(){
			this.modalBackground = document.createElement('div');
			this.modalBackground.classList.add('modalBackgroundShadow');
			document.body.insertBefore(this.modalBackground, this);
		}
		removeModalBackground(){
			document.body.removeChild(this.modalBackground);
		}
		onReady(){
			//callback for whe we istantiate from the server and are ready to show us
		}
		hideColumn(){
			//try to hide some columns

			var columnsToHide = [
				this.webkitShadowRoot.querySelector("#numero"),
				this.webkitShadowRoot.querySelector("#via"),
				this.webkitShadowRoot.querySelector("#cap"),
				this.webkitShadowRoot.querySelector("#alboautotrasportatori"),
				this.webkitShadowRoot.querySelector("#mezzo_codice"),
				this.webkitShadowRoot.querySelector("#vettore_codice"),
				this.webkitShadowRoot.querySelector("#iva_codice"),
				this.webkitShadowRoot.querySelector("#web"),
				this.webkitShadowRoot.querySelector("#valuta"),
				this.webkitShadowRoot.querySelector("#telefono"),
				this.webkitShadowRoot.querySelector("#cellulare"),
				this.webkitShadowRoot.querySelector("#fax"),
				this.webkitShadowRoot.querySelector("#email"),
				this.webkitShadowRoot.querySelector("#nome"),
			];

			console.log(columnsToHide);
			for (var i=0; i <= columnsToHide.length; i++){
				var column = columnsToHide[i];
				if(column){
					console.log('Column hidden', column);
					column.style.visibility='collapse';
				}
			}
		}
	}
		
		// Register the new element with the browser
		customElements.define(xMenu.is, xMenu);
	</script>
</dom-module>
