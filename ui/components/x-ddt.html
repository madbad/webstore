<polymer-element name="x-ddt" attributes="rigadamodificare">
	<template>
		<style>
		.displayRighe {
			height: 16em;
			width: 100%;
			border:0.1em solid grey;
			box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.333333);
			padding:0.2em;
			overflow-y: scroll;
		}
		.displayRighe  input{
			display: none;
		}
		displayRighe tbody {

		}
		.displayRighe thead{

		}
		tbody tr {
			background-image: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0) 88%,#eaeaea 100%);
		}
		.displayRighe table, thead, tbody, tfooter {
			width: 100%;
			border: 0px;
			padding:0px;
			margin:0px;
			border-collapse: collapse;
			border-spacing: 0;
		}
		.displayRighe label{
			background-color: transparent;
			color: grey;
		}
		.displayRighe thead td{
			font-weight: bold;
			background: linear-gradient(15deg, #616161 0%,#616161 4%,#7c7c7c 100%); /* W3C */
			font-weight:bold;
			color:white;
			font-size: 0.8em;
		}
		</style>

		<x-numerodoc val="{{ddt.numero}}" label="Numero"></x-numerodoc>
		<x-data val="{{ddt.data}}" label="Data"></x-data>
		<br>
		<x-codiceclientefornitore val="{{ddt.clientefornitore_codice}}" label="Cliente"></x-codiceclientefornitore>
		<br>
		<x-numerodoc val="{{ddt.fattura_numero}}" label="N.Fatt."></x-numerodoc>
		<x-data val="{{ddt.fattura_data}}" label="Data.Fatt."></x-data>

		<br>
		<x-codicecausale val="{{ddt.causale_codice}}" label="Causale di spedizione"></x-codicecausale>
		<br>
		<x-codicemezzo val="{{ddt.mezzo_codice}}" label="Mezzo di spedizione"></x-codicemezzo>
		<br>
		<x-codiceclientefornitore val="{{ddt.vettore_codice}}" label="Vettore"></x-codiceclientefornitore>
		<br>
		<x-note val="{{ddt.note}}" label="Note"></x-note>
		<br>
		Righe:
		<!--
		<template repeat="{{r in ddt.righe}}">
			<x-numeroriga val="{{r.numero}}" label="N." disabledstatus="true"></x-numeroriga>
			<x-codicearticolo val="{{r.articolo_codice}}" label="Art." disabledstatus="true"></x-codicearticolo>
			<x-codiceum val="{{r.um_codice}}" label="UM" disabledstatus="true"></x-codiceum>
			<x-prezzo val="{{r.prezzo}}" label="Prezzo" disabledstatus="true"></x-prezzo>
			<x-numerocolli val="{{r.colli}}" label="Colli" disabledstatus="true"></x-numerocolli>
			<x-codiceimballaggio val="{{r.imballaggio_codice}}" label="Tipo Imb." disabledstatus="true"></x-codiceimballaggio>
			<x-peso val="{{r.pesolordo}}" label="Lordo" disabledstatus="true"></x-peso>
			<x-peso val="{{r.tara}}" label="Tara" disabledstatus="true"></x-peso>
			<x-peso val="{{r.pesonetto}}" label="Netto" disabledstatus="true"></x-peso>
			<x-lotto val="{{r.lotto}}" label="Lotto" disabledstatus="true"></x-lotto>
			<x-codiceiva val="{{r.iva_codice}}" label="Iva" disabledstatus="true"></x-codiceiva>
			<hr>
		</template>
		-->
		<div class="displayRighe" tabindex="">
		<table>
			<thead>
			<tr>
				<td>Numero</td>
				<td>Articolo</td>
				<td>UM</td>
				<td>Prezzo</td>
				<td>Colli</td>
				<td>Imballaggio</td>
				<td>Lordo</td>
				<td>Tara</td>
				<td>Netto</td>
				<td>Lotto</td>
				<td>Iva</td>
			</tr>
			</thead>
			<tbody>
		<template repeat="{{r in ddt.righe}}">
			<tr>
			<td><x-numeroriga val="{{r.numero}}" label=" {{r.numero}}" disabledstatus="true"></x-numeroriga></td>
			<td><x-codicearticolo val="{{r.articolo_codice}}" label=" " disabledstatus="true"></x-codicearticolo></td>
			<td><x-codiceum val="{{r.um_codice}}" label=" " disabledstatus="true"></x-codiceum></td>
			<td><x-prezzo val="{{r.prezzo}}" label=" {{r.prezzo}}" disabledstatus="true"></x-prezzo></td>
			<td><x-numerocolli val="{{r.colli}}" label=" {{r.colli}}" disabledstatus="true"></x-numerocolli></td>
			<td><x-codiceimballaggio val="{{r.imballaggio_codice}}" label=" " disabledstatus="true"></x-codiceimballaggio></td>
			<td><x-peso val="{{r.pesolordo}}" label=" {{r.pesolordo}}" disabledstatus="true"></x-peso></td>
			<td><x-peso val="{{r.tara}}" label=" {{r.tara}}" disabledstatus="true"></x-peso></td>
			<td><x-peso val="{{r.pesonetto}}" label=" {{r.pesonetto}}" disabledstatus="true"></x-peso></td>
			<td><x-lotto val="{{r.lotto}}" label=" {{r.lotto}}" disabledstatus="true"></x-lotto></td>
			<td><x-codiceiva val="{{r.iva_codice}}" label=" " disabledstatus="true"></x-codiceiva></td>
			</tr>
		</template>
			</tbody>
		</table>
		</div>
	<!-- -->
	<br>
	Modifica Riga
	<BR>
	<x-numeroriga val="{{rigadamodificare.numero}}" label="N." id="numriga"></x-numeroriga>
	<x-codicearticolo val="{{rigadamodificare.articolo_codice}}" label="Art."></x-codicearticolo>
	<x-codiceum val="{{rigadamodificare.um_codice}}" label="UM"></x-codiceum>
	<x-prezzo val="{{rigadamodificare.prezzo}}" label="Prezzo"></x-prezzo>
	<x-numerocolli val="{{rigadamodificare.colli}}" label="Colli"></x-numerocolli>
	<x-codiceimballaggio val="{{rigadamodificare.imballaggio_codice}}" label="Tipo Imball."></x-codiceimballaggio>
	<x-peso val="{{rigadamodificare.pesolordo}}" label="Lordo"></x-peso>
	<x-peso val="{{rigadamodificare.tara}}" label="Tara"></x-peso>
	<x-peso val="{{rigadamodificare.pesonetto}}" label="Netto"></x-peso>
	<x-lotto val="{{rigadamodificare.lotto}}" label="Lotto"></x-lotto>
	<x-codiceiva val="{{rigadamodificare.iva_codice}}" label="Iva"></x-codiceiva>
	<!--
	<br>
	<template bind="{{rigadamodificare}}" id="rigaDaModificareTemplate">
		<script>
		
		</script>
		<x-numeroriga val="{{numero}}" label="N." id="numRigaDaModificare" on-blur={{registerInputNumRiga}}></x-numeroriga>
		<x-codicearticolo val="{{articolo_codice}}" label="Art."></x-codicearticolo>
		<x-codiceum val="{{um_codice}}" label="UM"></x-codiceum>
		<x-prezzo val="{{prezzo}}" label="Prezzo"></x-prezzo>
		<x-numerocolli val="{{colli}}" label="Colli"></x-numerocolli>
		<x-codiceimballaggio val="{{imballaggio_codice}}" label="Tipo Imball."></x-codiceimballaggio>
		<x-peso val="{{pesolordo}}" label="Lordo"></x-peso>
		<x-peso val="{{tara}}" label="Tara"></x-peso>
		<x-peso val="{{pesonetto}}" label="Netto"></x-peso>
		<x-lotto val="{{lotto}}" label="Lotto"></x-lotto>
		<x-codiceiva val="{{iva_codice}}" label="Iva"></x-codiceiva>
	</template>
	-->
	<!-- -->
	</template>
	<script>
		Polymer('x-ddt', {
			ready: function() {
				var ajax = {
				ddt:{
					_type:"Ddt",
					numero:"1934",
					data:"16/11/2013",
					clientefornitore_codice:"LAFAVO",
					causale_codice:"01",
					mezzo_codice:"01",
					vettore_codice:"03",
					fattura_numero:"",
					fattura_data:"",
					note:"Note per il ddt",
					righe: [
						{	numero: 0,
							articolo_codice: '01',
							um_codice: 'KG',
							prezzo: '0,001',
							colli: '10',
							imballaggio_codice: '01',
							pesolordo:'1000',
							tara:'100',
							pesonetto:'900',
							lotto:'1/A',
							iva_codice:'4',
							},
						{	numero: 1,
							articolo_codice: '03',
							um_codice: 'KG',
							prezzo: '0,001',
							colli: '10',
							imballaggio_codice: '01',
							pesolordo:'1000',
							tara:'100',
							pesonetto:'900',
							lotto:'1/A',
							iva_codice:'4',
							},
						{	numero: 0,
							articolo_codice: '31',
							um_codice: 'KG',
							prezzo: '0,001',
							colli: '10',
							imballaggio_codice: '01',
							pesolordo:'1000',
							tara:'100',
							pesonetto:'900',
							lotto:'1/A',
							iva_codice:'4',
							},
						{	numero: 1,
							articolo_codice: '20',
							um_codice: 'KG',
							prezzo: '0,001',
							colli: '10',
							imballaggio_codice: '01',
							pesolordo:'1000',
							tara:'100',
							pesonetto:'900',
							lotto:'1/A',
							iva_codice:'4',
							},
						{	numero: 0,
							articolo_codice: '29',
							um_codice: 'KG',
							prezzo: '0,001',
							colli: '10',
							imballaggio_codice: '01',
							pesolordo:'1000',
							tara:'100',
							pesonetto:'900',
							lotto:'1/A',
							iva_codice:'4',
							},
						{	numero: 1,
							articolo_codice: '08',
							um_codice: 'KG',
							prezzo: '0,001',
							colli: '10',
							imballaggio_codice: '01',
							pesolordo:'1000',
							tara:'100',
							pesonetto:'900',
							lotto:'1/A',
							iva_codice:'4',
							},
						{	numero: 0,
							articolo_codice: '05',
							um_codice: 'KG',
							prezzo: '0,001',
							colli: '10',
							imballaggio_codice: '01',
							pesolordo:'1000',
							tara:'100',
							pesonetto:'900',
							lotto:'1/A',
							iva_codice:'4',
							},
						{	numero: 1,
							articolo_codice: '19',
							um_codice: 'KG',
							prezzo: '0,001',
							colli: '10',
							imballaggio_codice: '01',
							pesolordo:'1000',
							tara:'100',
							pesonetto:'900',
							lotto:'1/A',
							iva_codice:'4',
							},
						]
				   }
				}
				this.ddt= ajax.ddt;
				
				//inizializza i campi per una nuova riga
				this.iniziaRiga();
				this.reindicizzaRighe();
				//tengo traccia di quale riga del mio ddt sto modificando
				this.numRigaWatcher = function (id, oldval, newval){
					console.log('numRiga changed. Newval: >', newval, '<')
					this.numriga= newval;
					if(newval !='' && newval !=null){
						this.displayMenu();
					}else{
						//this.iniziaRiga();
					}
				}.bind(this);
				this.rigadamodificare.watch('numero',this.numRigaWatcher);
			},
			displayMenu: function (){
				console.log('create the menu');
				var menu = document.createElement('x-menu');
				var list= [
					{label:'Modifica riga',_action:function (){this.modificaRiga(this.numriga);}.bind(this)},
					{label:'Cancella riga',_action:function (){this.eliminaRiga(this.numriga);}.bind(this)},
					{label:'Memorizza riga',_action:'none'},
					{label:'Stampa',_action:'none'},
					{label:'Avanti',_action:'none'},
					{label:'Indietro',_action:'none'},
					{label:'Abbandona',_action:'none'}
				];
				//remember the full list that compose the menu
				menu.fulllist = list;
				//generate the table for the menu
				var table = menu.generateTable (menu.fulllist);
				console.log('the table for the menu is redy:', table);

				console.log('Appending menu to the body:', menu);
				document.body.appendChild(menu);
				console.log('menu added!')

				menu.createMenu (table.tBodies[0].children);
				//wait a little and then position the help window in the middle of the body
				//and remember his width so that it does not change during future modifcation of contents
				//and show us
				menu.onConfirm = menu.onCancel = function (){
					console.log('do we see this????????????????????', this.$.numriga);
					this.$.numriga.focus();
				}.bind(this);
				
				setTimeout(function (){
					this.addModalBackground();
					var modifier = {
						top: -50,
						left: 50,
						}
					this.setPosition('bl','bl',document.body, modifier);
					this.show();
					this.focus();
				}.bind(menu), 150);

			},
			enteredView: function (){
				//#################################################
				//## UI LOGIC                                    ##
				//#################################################
/*
				
				setTimeout(function (){
					console.log('modifica riga:')
					console.log(this.$.numRigaDaModificare);
				
					this.$.impl.querySelector('x-numeroriga').blur = function (){
						console.log('SHOW A NEW MENU');
						this.displayMenu();
					}.bind(this);
				}.bind(this), 100);
				
*/
			},
			modificaRiga: function (numRiga){
				console.log('XDDT: richiesto di modificare la riga:', numRiga);
				this.rigadamodificare=JSON.parse(JSON.stringify(this.ddt.righe[numRiga]));
				//re register the watcher
				this.rigadamodificare.watch('numero',this.numRigaWatcher);
			},
			eliminaRiga: function (numRiga){
				this.rigadamodificare.numero=null;
				this.$.numriga.val=null;
				//this.iniziaRiga();
				console.log('XDDT: richiesto di cancellare la riga:', numRiga);
				this.ddt.righe.splice(numRiga, 1);
				this.reindicizzaRighe();

				//re register the watcher
				this.rigadamodificare.watch('numero',this.numRigaWatcher);
			},
			iniziaRiga: function (oRiga){
				this.rigadamodificare = {
							numero: null,
							articolo_codice: null,
							um_codice: null,
							prezzo: null,
							colli: null,
							imballaggio_codice: null,
							pesolordo:null,
							tara:null,
							pesonetto:null,
							lotto:null,
							iva_codice:null,
							};
			},
			reindicizzaRighe: function (oRiga){
				console.log('XDDT: reindicizzazzione righe in corso', this.ddt.righe.length)
				for (var i=0; i < this.ddt.righe.length; i++){
					var riga = this.ddt.righe[i];
					console.log('XDDT: riga ',riga.numero,'diventa ',i)
					riga.numero = i;
				}
			},
			memorizzaRiga: function (oRiga){
			
			},
			memorizzaDdt: function (){
				
			},
			abbandonaDdt: function (){
				
			}
		});
	</script>
</polymer-element>
